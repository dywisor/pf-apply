.\" Automatically generated by Pandoc 2.9.2.1
.\"
.TH "PF-APPLY" "1" "June 26, 2021" "Version 0.0" "pf-apply"
.hy
.SH NAME
.PP
\f[B]pf-apply\f[R] \[em] safely load new pf.conf
.SH SYNOPSIS
.PP
\f[B]pf-apply\f[R] [\f[B]-d\f[R]] [\f[B]-f \f[BI]file\f[B]\f[R]] [-I]
[-L] [-R] [\f[B]-t \f[BI]timeout\f[B]\f[R]]
.PD 0
.P
.PD
\f[B]pf-apply\f[R] \f[B]-h\f[R]
.SH DESCRIPTION
.PP
Loads a new pf.conf configuration file and waits for user feedback.
.PP
Only if the user accepts the new configuration within a specific time
frame, it gets installed to \f[I]/etc/pf.conf\f[R] and will be active on
the next boot as well.
.PP
Otherwise, the configuration gets rolled back to the previous rule set.
.PP
The typical scenario is updating the pf.conf on a remote machine via SSH
while avoiding to get locked out.
.PP
Overview of the actions taken by pf-apply:
.IP " 1." 4
Initialize logging
.IP " 2." 4
Block other instances by acquiring an advisory file lock (flock(2))
.IP " 3." 4
Copy the new pf.conf to a temporary file below \f[I]/etc\f[R] (PATH
FIXME) so that it can be atomically moved later on
.IP " 4." 4
Check the new pf.conf (using pfctl -n -f pf.conf.new)
.IP " 5." 4
Dump current states for recovery on error
.IP " 6." 4
Fork to background, detach tty and exit parent process
.RS 4
.PP
The parent process writes the pid of the child process to stdout prior
to exiting.
.RE
.IP " 7." 4
Load the new pf.conf file
.IP " 8." 4
Wait up to 30 seconds for user feedback whether the new configuration
should be kept or not.
.RS 4
.PP
To accept the new configuration, send SIGUSR1 to the process.
.PP
To discard it and roll back, send SIGTERM or SIGINT.
Alternatively, this option is also selected if no user feedback was
received at all, usually caused by being locked out by the new firewall
configuration.
.RE
.IP " 9." 4
User accepts the new configuration (SIGUSR1 received)
.RS 4
.PP
Rotate pf.conf files so that the new pf.conf configuration will be used
on next boot:
.IP \[bu] 2
\f[I]/etc/pf.conf\f[R] is moved to \f[I]/etc/pf.conf.old\f[R]
.IP \[bu] 2
The new configuration is moved to \f[I]/etc/pf.conf\f[R]
.PP
This step uses hardlinks to ensure a mostly atomic operation.
.RE
.IP "10." 4
User does not accept the new configuration (timeout or SIGTERM/SIGINT
received)
.RS 4
.IP \[bu] 2
Load \f[I]/etc/pf.conf\f[R]
.IP \[bu] 2
Restore firewall states from the previously created temporary file
.PP
Alternatively, disable the firewall altogether (\f[B]-d\f[R] option).
.RE
.IP "11." 4
Clean up temporary files, stop logging
.SH OPTIONS
.TP
-d
Instead of restoring the firewall rules from \f[I]/etc/pf.conf\f[R] on
error, disable the firewall completely (pfctl -d).
.RS
.PP
Not recommended, use at your own discretion.
.RE
.TP
-f \f[I]file\f[R]
pf.conf file to be loaded.
.RS
.PP
Defaults to \f[I]FIXME\f[R].
.RE
.TP
-I
Do not install the new pf.conf file to \f[I]FIXME\f[R].
.TP
-L
Do not acquire a lock
.TP
-R
Do not restore pf states on error
.RS
.PP
This also disables dumping of pf states.
.RE
.TP
-t \f[I]timeout\f[R]
Maximum time to wait for user feedback whether the new pf.conf should be
kept or not.
.RS
.PP
Defaults to 30 seconds.
.RE
.SH EXIT CODES
.TP
0
Success
.TP
1
Unspecified error
.TP
2
Blocked by other instance (failed to acquire lock)
.TP
10
Failed to copy new pf.conf file to temporary file
.TP
11
New pf.conf did not pass syntax check
.TP
12
Failed to dump current states to temporary file
.TP
15
User did not accept new configuration, states restored
.TP
18
Failed to rollover pf.conf, states restored
.TP
35
User did not accept new configuration, states not restored
.TP
38
Failed to rollover pf.conf, states not restored
.TP
64
Usage error
.TP
70
Software logic broken
.TP
71
Failed to get system resources
.SH FILES
.TP
\f[I]FIXME\f[R]
The default new pf.conf file to be loaded when no \f[B]-f\f[R] option is
given.
.TP
\f[I]FIXME\f[R]
Path to the lockfile used for blocking simultaneous execution of
pf-apply.
.SH LIMITATIONS
.PP
pf-apply will restore the configuration from \f[I]/etc/pf.conf\f[R] on
error.
Previous rules stored in dynamic anchors or loaded from other files will
be discarded.
.PP
No attempt is made to freeze tables, previous entries may be lost.
In particular, changed table files (\[aq]table <foo> file
\[dq]file-path\[dq]\[cq]) will affect the restored configuration.
.SH BUGS
.PP
See GitHub Issues: <https://github.com/dywisor/pf-apply/issues>
.SH SEE ALSO
.PP
\f[C]pfctl\f[R](8)
.SH AUTHORS
Andr\['e] Erdmann <dywi@mailerd.de>.
